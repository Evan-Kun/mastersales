{% extends "base.html" %}
{% block title %}Proposals{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900">Proposals</h2>
    <p class="text-sm text-gray-500 mt-1">Generate branded PDF and email proposals</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Create Proposal -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Create New Proposal</h3>
        <form action="/proposals/create" method="post" class="space-y-4" x-data="{ selectedProducts: [] }">
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Contact</label>
                <select name="contact_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    {% for contact in contacts %}
                    <option value="{{ contact.id }}">{{ contact.first_name }} {{ contact.last_name or '' }} {% if contact.company %}({{ contact.company.company_name }}){% endif %}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-500 mb-3">Products / Services</label>
                <div class="space-y-3">
                    {% for product in products %}
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <input type="checkbox" name="products" value="{{ product.name }}" id="prod-{{ loop.index }}"
                               class="h-4 w-4 text-navy rounded border-gray-300">
                        <div class="flex-1">
                            <label for="prod-{{ loop.index }}" class="text-sm font-medium text-gray-700 cursor-pointer">{{ product.name }}</label>
                            <p class="text-xs text-gray-500">{{ product.description }}</p>
                            <p class="text-xs font-medium text-green-600">${{ "{:,.2f}".format(product.price_per_litre) }} per unit</p>
                        </div>
                        <div>
                            <input type="number" name="quantities" value="1" min="1" step="1"
                                   class="w-20 px-2 py-1 border border-gray-300 rounded text-sm text-center">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Notes / Custom Terms</label>
                <textarea name="notes" rows="3" placeholder="Additional notes for the proposal..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
            </div>

            <button type="submit" class="w-full px-4 py-2 bg-navy text-white rounded-lg text-sm font-medium hover:bg-navy-light transition-colors">
                Generate Proposal
            </button>
        </form>
    </div>

    <!-- Proposals List -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-4 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">All Proposals</h3>
            </div>

            {% if proposals %}
            <div class="divide-y divide-gray-100">
                {% for proposal in proposals %}
                <div class="p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-900">
                                {{ proposal.contact.first_name }} {{ proposal.contact.last_name or '' }}
                                {% if proposal.contact.company %} - {{ proposal.contact.company.company_name }}{% endif %}
                            </p>
                            <div class="flex items-center gap-3 mt-1">
                                <span class="text-lg font-bold text-green-600">${{ "{:,.2f}".format(proposal.pricing) }}</span>
                                {% set status_colors = {"Draft": "bg-gray-100 text-gray-700", "Sent": "bg-blue-100 text-blue-700", "Viewed": "bg-purple-100 text-purple-700", "Accepted": "bg-green-100 text-green-700", "Declined": "bg-red-100 text-red-700"} %}
                                <span class="badge {{ status_colors.get(proposal.status, 'bg-gray-100 text-gray-700') }}">{{ proposal.status }}</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">
                                Created {{ proposal.created_at.strftime('%d %b %Y') }}
                                {% if proposal.sent_at %} | Sent {{ proposal.sent_at.strftime('%d %b %Y') }}{% endif %}
                            </p>
                            {% if proposal.products %}
                            <div class="flex flex-wrap gap-1 mt-2">
                                {% for product in proposal.products %}
                                <span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">{{ product.name }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex flex-col gap-2">
                            {% if proposal.pdf_path %}
                            <a href="/proposals/{{ proposal.id }}/pdf" class="px-3 py-1.5 bg-navy text-white rounded text-xs font-medium hover:bg-navy-light text-center transition-colors">
                                Download PDF
                            </a>
                            {% endif %}
                            {% if proposal.email_html %}
                            <a href="/proposals/{{ proposal.id }}/email-preview" target="_blank" class="px-3 py-1.5 bg-amber text-white rounded text-xs font-medium hover:bg-amber-light text-center transition-colors">
                                Email Preview
                            </a>
                            {% endif %}
                            {% if proposal.status == 'Draft' %}
                            <form action="/proposals/{{ proposal.id }}/send" method="post">
                                <button class="w-full px-3 py-1.5 bg-green-100 text-green-700 rounded text-xs font-medium hover:bg-green-200 transition-colors">
                                    Mark as Sent
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-8 text-center text-gray-400">
                <p>No proposals yet. Create your first one!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
